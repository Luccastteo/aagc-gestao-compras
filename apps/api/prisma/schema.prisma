// AAGC SaaS Multi-Tenant Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTH & TENANCY ====================

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  plan      String   @default("free") // free, pro, enterprise
  status    String   @default("active") // active, suspended
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users          User[]
  suppliers      Supplier[]
  items          Item[]
  purchaseOrders PurchaseOrder[]
  kanbanBoards   KanbanBoard[]
  kanbanCards    KanbanCard[]
  auditLogs      AuditLog[]
  commsLogs      CommsLog[]
  inventoryAlerts     InventoryAlert[]
  purchaseSuggestions PurchaseSuggestion[]
  consumptionHistory  ConsumptionHistory[]
  supplierPerformance SupplierPerformance[]
  priceHistory        PriceHistory[]
  predictions         MLPrediction[]
  decisionLogs        DecisionLog[]
  knowledgeDocuments  KnowledgeDocument[]
  policy              PurchasePolicy?

  @@map("organizations")
}

enum Role {
  OWNER
  MANAGER
  OPERATOR
  VIEWER
}

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  password         String
  name             String
  role             Role      @default(VIEWER)
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  isActive         Boolean   @default(true)
  lastLogin        DateTime?
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  createdPurchaseOrders  PurchaseOrder[] @relation("CreatedBy")
  approvedPurchaseOrders PurchaseOrder[] @relation("ApprovedBy")
  auditLogs              AuditLog[]
  createdKanbanCards     KanbanCard[]

  @@index([organizationId])
  @@map("users")
}

// ==================== SUPPLIERS ====================

model Supplier {
  id             String   @id @default(uuid())
  codigo         String
  nome           String
  cnpj           String?
  email          String?
  telefone       String?
  whatsapp       String?
  prazoMedioDias Int      @default(7)
  qualidade      String   @default("ok") // excelente, bom, ok, ruim
  status         String   @default("ativo")
  isDefault      Boolean  @default(false) // Default supplier for org when item has no supplier
  observacoes    String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  items          Item[]
  purchaseOrders PurchaseOrder[]
  purchaseSuggestions PurchaseSuggestion[]
  performance    SupplierPerformance[]
  priceHistory   PriceHistory[]

  @@unique([organizationId, codigo])
  @@index([organizationId])
  @@index([organizationId, isDefault])
  @@map("suppliers")
}

// ==================== INVENTORY ====================

model Item {
  id                     String   @id @default(uuid())
  sku                    String
  descricao              String
  categoria              String?
  unidade                String   @default("UN")
  saldo                  Int      @default(0)
  minimo                 Int      @default(0)
  maximo                 Int      @default(100)
  leadTimeDays           Int      @default(7)
  custoUnitario          Float    @default(0)
  supplierId             String?
  supplier               Supplier? @relation(fields: [supplierId], references: [id])
  localizacao            String?
  observacoes            String?
  organizationId         String
  organization           Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  purchaseOrderItems PurchaseOrderItem[]
  movements          Movement[]
  inventoryAlerts    InventoryAlert[]
  purchaseSuggestions PurchaseSuggestion[]
  consumptionHistory ConsumptionHistory[]
  priceHistory       PriceHistory[]
  predictions        MLPrediction[]

  @@unique([organizationId, sku])
  @@index([organizationId])
  @@index([organizationId, saldo])
  @@map("items")
}

model Movement {
  id          String   @id @default(uuid())
  itemId      String
  item        Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  tipo        String   // ENTRADA, SAIDA, AJUSTE
  quantidade  Int
  saldoAntes  Int
  saldoDepois Int
  motivo      String?
  responsavel String
  createdAt   DateTime @default(now())

  @@index([itemId])
  @@map("movements")
}

// ==================== PURCHASE ORDERS ====================

enum POStatus {
  DRAFT
  APPROVED
  SENT
  DELIVERED
  CANCELLED
}

enum POSource {
  MANUAL
  AUTO_REPLENISH
}

model PurchaseOrder {
  id                String   @id @default(uuid())
  codigo            String
  status            POStatus @default(DRAFT)
  source            POSource @default(MANUAL)
  supplierId        String
  supplier          Supplier @relation(fields: [supplierId], references: [id])
  valorTotal        Float    @default(0)
  observacoes       String?
  createdById       String
  createdBy         User     @relation("CreatedBy", fields: [createdById], references: [id])
  approvedById      String?
  approvedBy        User?    @relation("ApprovedBy", fields: [approvedById], references: [id])
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  dataAbertura      DateTime @default(now())
  dataAprovacao     DateTime?
  dataEnvio         DateTime?
  previsaoEntrega   DateTime?
  dataRecebimento   DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Auto PO fields
  dedupeKey         String?           // AUTO:{orgId}:{supplierId}:{windowStartISO}
  windowStart       DateTime?         // Window boundary (6h blocks)
  needsQuote        Boolean  @default(false)
  lastAutoUpdateAt  DateTime?

  items       PurchaseOrderItem[]
  kanbanCards KanbanCard[]
  purchaseSuggestions PurchaseSuggestion[]

  @@unique([organizationId, codigo])
  @@unique([organizationId, dedupeKey])
  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, status, source, createdAt])
  @@index([organizationId, supplierId, status])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  itemId          String
  item            Item          @relation(fields: [itemId], references: [id])
  quantidade      Int
  precoUnitario   Float
  valorTotal      Float
  needsQuote      Boolean       @default(false)

  @@unique([purchaseOrderId, itemId])
  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}

// ==================== KANBAN ====================

model KanbanBoard {
  id             String   @id @default(uuid())
  nome           String
  descricao      String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  cards KanbanCard[]

  @@index([organizationId])
  @@map("kanban_boards")
}

enum KanbanStatus {
  TODO
  IN_PROGRESS
  DONE
}

model KanbanCard {
  id              String        @id @default(uuid())
  titulo          String
  descricao       String?
  status          KanbanStatus  @default(TODO)
  posicao         Int           @default(0)
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  externalRef     String?       // Reference for AUTO POs (poId) - unique per org
  boardId         String
  board           KanbanBoard   @relation(fields: [boardId], references: [id], onDelete: Cascade)
  createdById     String
  createdBy       User          @relation(fields: [createdById], references: [id])
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([organizationId, externalRef])
  @@index([organizationId])
  @@index([boardId, status])
  @@map("kanban_cards")
}

// ==================== AUDIT & LOGS ====================

model AuditLog {
  id             String   @id @default(uuid())
  actorUserId    String?
  actorUser      User?    @relation(fields: [actorUserId], references: [id], onDelete: SetNull)
  action         String   // CREATE, UPDATE, DELETE, APPROVE, SEND, RECEIVE, AUTO_PO_*
  entity         String   // Item, PurchaseOrder, KanbanCard, etc
  entityId       String
  before         String?  @db.Text // JSON
  after          String?  @db.Text // JSON
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())

  @@index([organizationId])
  @@index([organizationId, entity])
  @@index([organizationId, actorUserId])
  @@index([organizationId, action])
  @@index([organizationId, entityId])
  @@map("audit_logs")
}

model CommsLog {
  id             String   @id @default(uuid())
  tipo           String   // EMAIL, WHATSAPP
  destinatario   String
  assunto        String?
  mensagem       String   @db.Text
  status         String   // SENT, FAILED, SIMULATED
  entity         String?
  entityId       String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())

  @@index([organizationId])
  @@index([organizationId, entity, entityId])
  @@map("comms_logs")
}

// ==================== ALERTS & SUGGESTIONS ====================

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
}

enum AlertStatus {
  OPEN
  ACK
  CLOSED
}

model InventoryAlert {
  id             String        @id @default(uuid())
  severity       AlertSeverity @default(MEDIUM)
  status         AlertStatus   @default(OPEN)
  reason         String
  itemId         String
  item           Item          @relation(fields: [itemId], references: [id], onDelete: Cascade)
  snapshot       String?       @db.Text // JSON (estado do item no momento)
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, createdAt])
  @@unique([organizationId, itemId, status])
  @@map("inventory_alerts")
}

enum SuggestionStatus {
  OPEN
  USED
  IGNORED
}

model PurchaseSuggestion {
  id             String           @id @default(uuid())
  status         SuggestionStatus @default(OPEN)
  itemId         String
  item           Item             @relation(fields: [itemId], references: [id], onDelete: Cascade)
  supplierId     String?
  supplier       Supplier?        @relation(fields: [supplierId], references: [id])
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder?  @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  suggestedQty   Int
  unitCost       Float
  estimatedTotal Float
  reason         String
  snapshot       String?          @db.Text // JSON (estado do item no momento)
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, createdAt])
  @@index([organizationId, purchaseOrderId])
  @@unique([organizationId, itemId, status])
  @@map("purchase_suggestions")
}

// ============================================
// CAMADA DE INTELIGÊNCIA ARTIFICIAL
// ============================================

/// Histórico de consumo diário por item para treinar modelos ML
model ConsumptionHistory {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  itemId         String
  item           Item         @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  date           DateTime     @default(now())
  quantity       Float        // Quantidade consumida no período
  
  // Contexto para ML (sazonalidade)
  dayOfWeek      Int          // 0-6 (domingo a sábado)
  month          Int          // 1-12
  quarter        Int          // 1-4
  year           Int
  weekOfYear     Int          // 1-53
  isHoliday      Boolean      @default(false)
  
  // Fonte do consumo
  source         String       // 'MANUAL_ADJUSTMENT', 'PO_RECEIVED', 'SYSTEM_CALCULATED'
  
  createdAt      DateTime     @default(now())
  
  @@unique([organizationId, itemId, date])
  @@index([organizationId, itemId, date])
  @@index([organizationId, date])
  @@map("consumption_history")
}

/// Performance calculada de fornecedores baseada em histórico real
model SupplierPerformance {
  id                    String       @id @default(uuid())
  organizationId        String
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  supplierId            String
  supplier              Supplier     @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  // Métricas calculadas
  avgLeadTimeDays       Float        // Lead time médio real
  onTimeDeliveryRate    Float        // % entregas no prazo (0-1)
  qualityScore          Float        // Score de qualidade (0-100)
  priceCompetitiveness  Float        // Quão competitivo vs mercado (0-100)
  communicationScore    Float        // Responsividade (0-100)
  
  // Dados brutos
  totalOrders           Int          @default(0)
  completedOrders       Int          @default(0)
  lateOrders            Int          @default(0)
  canceledOrders        Int          @default(0)
  
  // Variação de preços
  avgPriceVariation     Float        @default(0) // % média de variação vs histórico
  
  // Timestamps
  lastEvaluatedAt       DateTime     @default(now())
  dataFrom              DateTime     // Início do período avaliado
  dataTo                DateTime     // Fim do período avaliado
  
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  
  @@unique([organizationId, supplierId])
  @@index([organizationId, supplierId])
  @@map("supplier_performance")
}

/// Histórico de variação de preços por item e fornecedor
model PriceHistory {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  itemId         String
  item           Item         @relation(fields: [itemId], references: [id], onDelete: Cascade)
  supplierId     String?
  supplier       Supplier?    @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  
  price          Float
  currency       String       @default("BRL")
  quantity       Float        // Quantidade cotada
  
  // Fonte do preço
  source         String       // 'PURCHASE_ORDER', 'QUOTATION', 'MANUAL_ENTRY', 'MARKETPLACE'
  referenceId    String?      // ID do PO ou cotação
  
  effectiveDate  DateTime     @default(now())
  createdAt      DateTime     @default(now())
  
  @@index([organizationId, itemId, effectiveDate])
  @@index([organizationId, supplierId, effectiveDate])
  @@map("price_history")
}

/// Previsões de modelos de Machine Learning
model MLPrediction {
  id              String       @id @default(uuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  itemId          String
  item            Item         @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  predictionType  String       // 'DEMAND_FORECAST', 'LEAD_TIME', 'PRICE_TREND', 'URGENCY_SCORE'
  model           String       // 'PROPHET', 'ARIMA', 'LSTM', 'RANDOM_FOREST', 'XGB'
  version         String       // Versão do modelo
  
  // Previsão
  forecastHorizon Int          // Dias à frente
  predictedValue  Float   
  confidence      Float        // 0-1
  lowerBound      Float?       // Intervalo de confiança inferior
  upperBound      Float?       // Intervalo de confiança superior
  
  // Metadata
  features        Json         // Features usadas na previsão
  parameters      Json         // Hiperparâmetros do modelo
  
  // Validação posterior
  actualValue     Float?       // Valor real (preenchido posteriormente)
  error           Float?       // Erro absoluto
  
  forecastDate    DateTime     // Data para qual foi feita a previsão
  createdAt       DateTime     @default(now())
  
  @@index([organizationId, itemId, predictionType, forecastDate])
  @@index([organizationId, createdAt])
  @@map("ml_predictions")
}

/// Log completo de decisões tomadas pela IA
model DecisionLog {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  decisionType   String       // 'AUTO_APPROVE', 'CREATE_PO', 'ESCALATE', 'REJECT', 'SUPPLIER_SELECT'
  entity         String       // 'PURCHASE_ORDER', 'PURCHASE_SUGGESTION', 'INVENTORY_ALERT'
  entityId       String
  
  // Input da decisão
  inputData      Json         // Contexto completo
  
  // Raciocínio da IA
  reasoning      Json         // { factors: [], weights: {}, confidence: 0.85, alternatives: [] }
  llmExplanation String?      @db.Text // Explicação em linguagem natural
  
  // Output
  decision       String       // Decisão tomada
  confidence     Float        // 0-1
  
  // Validação posterior (aprendizado)
  wasCorrect     Boolean?
  feedback       String?      @db.Text
  correctedBy    String?      // userId que corrigiu
  
  // Timestamps
  decidedAt      DateTime     @default(now())
  evaluatedAt    DateTime?
  
  createdAt      DateTime     @default(now())
  
  @@index([organizationId, decisionType, decidedAt])
  @@index([organizationId, entityId])
  @@map("decision_logs")
}

/// Base de conhecimento para RAG (Retrieval-Augmented Generation)
model KnowledgeDocument {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  type           String       // 'POLICY', 'CONTRACT', 'MANUAL', 'MEMO', 'FAQ'
  title          String
  content        String       @db.Text
  
  // RAG - Embeddings (requer pgvector) - comentado temporariamente
  // embedding      Unsupported("vector(1536)")? // OpenAI text-embedding-3-small
  
  // Metadata
  tags           String[]     @default([])
  category       String?
  version        String       @default("1.0")
  language       String       @default("pt-BR")
  
  // Acesso
  isActive       Boolean      @default(true)
  restrictedTo   String[]     @default([]) // roleIds com acesso
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  createdBy      String       // userId
  
  @@index([organizationId, type, isActive])
  @@map("knowledge_documents")
}

/// Políticas de compras configuráveis por organização
model PurchasePolicy {
  id                        String       @id @default(uuid())
  organizationId            String       @unique
  organization              Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Limites de auto-aprovação
  autoApproveThreshold      Float        @default(5000) // R$ máximo para auto-aprovar
  requiresQuotesAbove       Float        @default(1000) // R$ mínimo para exigir cotações
  minQuotesRequired         Int          @default(3)
  
  // Fornecedores
  preferredSupplierIds      String[]     @default([])
  blockedSupplierIds        String[]     @default([])
  
  // Lead time
  maxAcceptableLeadTimeDays Int          @default(30)
  urgentThresholdDays       Int          @default(7)   // Considerar urgente se <= 7 dias
  
  // Preços
  priceVariationTolerance   Float        @default(0.15) // 15% tolerância vs histórico
  
  // Estoque
  safetyStockMultiplier     Float        @default(1.5)  // min = demanda_média * 1.5
  reorderPointDays          Int          @default(14)   // Reabastecer quando < 14 dias
  
  // Automação (feature flags)
  enableAutoApproval        Boolean      @default(false)
  enableAutoPurchase        Boolean      @default(false) // Comprar sem intervenção humana
  
  // Exceções
  allowEmergencyOverride    Boolean      @default(true)
  
  createdAt                 DateTime     @default(now())
  updatedAt                 DateTime     @updatedAt
  
  @@map("purchase_policies")
}
